<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tip-at-Comment (Base) — Robust Connect</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 760px; margin: 40px auto; padding: 0 16px; }
    label { display:block; margin-top:14px; font-weight:600; }
    input { width: 100%; padding: 10px; margin-top: 6px; }
    button { margin-top: 12px; padding: 10px 14px; cursor: pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space: pre-wrap; }
    .row { display:flex; gap:10px; flex-wrap: wrap; }
    .hint { color:#555; font-size: 14px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>Tip a Comment on Base</h2>

  <div class="row">
    <button id="connectBtn">1) Connect Wallet</button>
    <button id="switchBtn">2) Switch/Add Base (8453)</button>
  </div>
  <p id="status" class="mono"></p>

  <label>Comment text or URL</label>
  <input id="comment" placeholder="Paste a cast URL or write any text…">

  <label>Recipient (0x address)</label>
  <input id="recipient" placeholder="0xABC...123">

  <label>Amount (ETH)</label>
  <input id="amount" value="0.0001">

  <button id="tipBtn">3) Send Tip</button>

  <p class="hint">
    If the page can’t see MetaMask:
    <br>• Open this via <b>http://localhost</b> (e.g., run <code>python -m http.server 5500</code>) OR
    <br>• Enable MetaMask’s <i>Allow access to file URLs</i> in Chrome → Extensions → MetaMask → Details.
    <br>• Ensure MetaMask is <b>unlocked</b> and no other wallet extensions override it (e.g., Brave Wallet).
  </p>

  <!-- ethers.js v5 (global 'ethers') — primary CDN with fallback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"
          onerror="(function(){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js';document.head.appendChild(s);})();"></script>

  <script>
    const CONTRACT = "0x36FF9732e7E7fd57aE010C287454fe18ad574761"; // Base mainnet contract
    const ABI = [
      "function tip(bytes32 commentId, address recipient) payable",
      "function totalByComment(bytes32) view returns (uint256)"
    ];

    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");
    const switchBtn = document.getElementById("switchBtn");
    const tipBtn = document.getElementById("tipBtn");

    function log(line){ statusEl.textContent += (line + "\n"); }
    function clearLog(){ statusEl.textContent = ""; }

    async function getEthereumProvider() {
      if (window.ethereum) return window.ethereum;
      await new Promise(r => {
        window.addEventListener('ethereum#initialized', r, { once: true });
        setTimeout(r, 1200);
      });
      return window.ethereum || null;
    }

    async function ensureEthers(){
      const start = Date.now();
      while (!window.ethers && Date.now() - start < 3000) {
        await new Promise(r => setTimeout(r, 50));
      }
      return !!window.ethers;
    }

    async function connectWallet() {
      clearLog();
      try {
        if (!(await ensureEthers())) throw new Error("ethers.js failed to load.");
        const eth = await getEthereumProvider();
        if (!eth) throw new Error("MetaMask not detected. Use http(s) or enable 'Allow access to file URLs' for MetaMask.");

        log("Requesting accounts...");
        const accounts = await eth.request({ method: "eth_requestAccounts" });
        if (!accounts || !accounts.length) throw new Error("No account returned.");
        log("Connected: " + accounts[0]);

        const chainId = await eth.request({ method: "eth_chainId" });
        log("Current chainId: " + chainId);
        log("If not 0x2105 (Base), click 'Switch/Add Base (8453)'. ");
      } catch (e) {
        log("Connect error: " + (e.message || e));
      }
    }

    async function switchToBase() {
      try {
        const eth = await getEthereumProvider();
        if (!eth) throw new Error("MetaMask not detected.");
        log("Switching to Base (0x2105)...");
        await eth.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0x2105" }] });
        log("Switched to Base.");
      } catch (e) {
        if (e && e.code === 4902) {
          log("Base not found. Adding Base...");
          try {
            await ethereum.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: "0x2105",
                chainName: "Base Mainnet",
                nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
                rpcUrls: ["https://mainnet.base.org"],
                blockExplorerUrls: ["https://basescan.org"]
              }]
            });
            log("Base added. Try switching again if needed.");
          } catch (err) {
            log("Add chain failed: " + (err.message || err));
          }
        } else {
          log("Switch failed: " + (e.message || e));
        }
      }
    }

    async function sendTip() {
      try {
        const eth = await getEthereumProvider();
        if (!eth) throw new Error("MetaMask not detected.");
        const provider = new ethers.providers.Web3Provider(eth);
        const signer = provider.getSigner();

        const net = await provider.getNetwork();
        if (net.chainId !== 8453) throw new Error("Not on Base (8453). Click 'Switch/Add Base' first.");

        const commentText = document.getElementById("comment").value.trim();
        const recipient = document.getElementById("recipient").value.trim();
        const amountEth = document.getElementById("amount").value.trim();
        if (!commentText) throw new Error("Enter a comment or URL.");
        if (!/^0x[a-fA-F0-9]{40}$/.test(recipient)) throw new Error("Recipient must be a 0x address.");
        if (!amountEth || Number(amountEth) <= 0) throw new Error("Enter a positive ETH amount.");

        const commentId = ethers.utils.id(commentText);
        const contract = new ethers.Contract(CONTRACT, ABI, signer);
        log("Sending tx...");
        const tx = await contract.tip(commentId, recipient, { value: ethers.utils.parseEther(amountEth) });
        log("Tx sent: " + tx.hash);
        const receipt = await tx.wait();
        log("Confirmed in block " + receipt.blockNumber + "\nExplorer: https://basescan.org/tx/" + tx.hash);
      } catch (e) {
        log("Tip error: " + (e.message || e));
      }
    }

    connectBtn.onclick = connectWallet;
    switchBtn.onclick = switchToBase;
    tipBtn.onclick = sendTip;
  </script>
</body>
</html>
