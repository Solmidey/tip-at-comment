<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Tip-at-Comment (Base)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 680px; margin: 40px auto; padding: 0 16px; }
    input { width: 100%; padding: 10px; margin: 6px 0 14px; }
    button { padding: 10px 14px; cursor: pointer; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <h2>Tip a Comment on Base</h2>

  <label>Comment text or URL</label>
  <input id="comment" placeholder="Paste a cast URL or write any text…" />

  <label>Recipient (0x address)</label>
  <input id="recipient" placeholder="0xABC...123" />

  <label>Amount (ETH)</label>
  <input id="amount" value="0.0001" />

  <button id="tipBtn">Connect & Tip on Base</button>
  <p id="status" class="mono"></p>

  <!-- ethers.js v5 (global 'ethers') — primary CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"
          integrity="sha512-+r2JWe8mD9jvULWJXv3Q7rGz4mQwW8wXc9iP8qYq3x2qQv7qH7KcU3xQHcKa9zQq5y7iF1z2Bz0wGqz7s9X48w=="
          crossorigin="anonymous"
          onerror="(function(){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js';document.head.appendChild(s);})();"></script>

  <script>
    // Wait until ethers is available
    async function waitForEthers(ms=1500){
      const start = Date.now();
      while (!window.ethers && Date.now()-start < ms) {
        await new Promise(r=>setTimeout(r,50));
      }
      return !!window.ethers;
    }

    async function getEthereumProvider() {
      if (window.ethereum) return window.ethereum;
      await new Promise(r => {
        window.addEventListener('ethereum#initialized', r, { once: true });
        setTimeout(r, 1200);
      });
      return window.ethereum || null;
    }

    (async function main(){
      const ok = await waitForEthers(3000);
      if (!ok) {
        document.getElementById('status').textContent = "Failed to load ethers.js. Try reloading, disable ad-block, or use http://localhost.";
        return;
      }

      const CONTRACT = "0x36FF9732e7E7fd57aE010C287454fe18ad574761";
      const ABI = [
        "function tip(bytes32 commentId, address recipient) payable",
        "function totalByComment(bytes32) view returns (uint256)"
      ];

      const statusEl = document.getElementById("status");
      document.getElementById("tipBtn").onclick = async () => {
        try {
          statusEl.textContent = "";

          const eth = await getEthereumProvider();
          if (!eth) throw new Error("MetaMask not detected. Open via http(s) or enable 'Allow access to file URLs' in MetaMask extension settings.");

          // Connect wallet
          const provider = new ethers.providers.Web3Provider(eth);
          await provider.send("eth_requestAccounts", []);
          const signer = provider.getSigner();

          // Ensure Base mainnet (8453)
          const net = await provider.getNetwork();
          if (net.chainId !== 8453) {
            await eth.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: "0x2105", // 8453
                chainName: "Base Mainnet",
                nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
                rpcUrls: ["https://mainnet.base.org"],
                blockExplorerUrls: ["https://basescan.org"]
              }]
            });
          }

          // Read inputs
          const commentText = document.getElementById("comment").value.trim();
          const recipient = document.getElementById("recipient").value.trim();
          const amountEth = document.getElementById("amount").value.trim();

          if (!commentText) throw new Error("Enter a comment or URL.");
          if (!/^0x[a-fA-F0-9]{40}$/.test(recipient)) throw new Error("Recipient must be a 0x address.");
          if (!amountEth || Number(amountEth) <= 0) throw new Error("Enter a positive ETH amount.");

          // commentId = keccak256(string) (v5 global)
          const commentId = ethers.utils.id(commentText);

          // Send tx
          const contract = new ethers.Contract(CONTRACT, ABI, signer);
          const tx = await contract.tip(commentId, recipient, { value: ethers.utils.parseEther(amountEth) });
          statusEl.textContent = "Tx sent: " + tx.hash;

          const receipt = await tx.wait();
          statusEl.innerHTML = `Confirmed in block ${receipt.blockNumber} — ` +
            `<a target="_blank" href="https://basescan.org/tx/${tx.hash}">view on Basescan</a>`;
        } catch (e) {
          statusEl.textContent = e.message || String(e);
        }
      };
    })();
  </script>
</body>
</html>
